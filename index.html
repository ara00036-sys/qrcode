<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Code Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script> <!-- QRious Library -->
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f6f9ff; }
    .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 18px; border-radius: 10px; box-shadow: 0 6px 20px rgba(20, 30, 60, 0.06); }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #d8e6ff; background: transparent; cursor: pointer; }
    .btn-primary { background: #2d7ff9; color: #fff; border: 0; }
    #qrContainer canvas { display: block; max-width: 100%; height: auto; background: #fff; border: 1px solid #eaf0ff; border-radius: 6px; }
    #message { margin-top: 8px; color: #666; }
  </style>
</head>
<body>
  <main class="container">
    <h1>QR Code Generator</h1>

    <label for="textInput">Enter a URL or any text</label><br/>
    <textarea id="textInput" rows="2" style="width:100%" placeholder="https://example.com or some text"></textarea>

    <div class="controls" style="margin-top: 10px">
      <label>Size: <span id="sizeValue">256</span> px
        <input id="sizeRange" type="range" min="128" max="1024" value="256" style="vertical-align:middle;width:180px;margin-left:8px"/>
      </label>

      <button id="generateBtn" class="btn">Generate QR</button>
      <a id="downloadLink" class="btn btn-primary" download="qrcode.png" href="#" role="button">Download PNG</a>
      <button id="clearBtn" class="btn" title="Clear QR">Clear</button>
    </div>

    <section class="preview" style="margin-top: 16px">
      <h2>Preview</h2>
      <div id="qrContainer" aria-label="Generated QR code" style="width: fit-content"></div>
      <p id="previewText" style="color: #666"></p>
    </section>

    <section class="test" style="margin-top: 12px">
      <h3>Quick Test</h3>
      <p>
        Sample: <button id="sampleBtn" class="btn">https://example.com</button>
      </p>
      <div id="message" role="status" aria-live="polite">Status: ready</div>
    </section>
  </main>

  <script>
    (function () {
      const textInput = document.getElementById('textInput');
      const generateBtn = document.getElementById('generateBtn');
      const downloadLink = document.getElementById('downloadLink');
      const qrContainer = document.getElementById('qrContainer');
      const sizeRange = document.getElementById('sizeRange');
      const sizeValue = document.getElementById('sizeValue');
      const previewText = document.getElementById('previewText');
      const sampleBtn = document.getElementById('sampleBtn');
      const messageEl = document.getElementById('message');
      const clearBtn = document.getElementById('clearBtn');

      let lastBlobUrl = null;

      function log(msg) {
        console.log('[QR DEBUG] ' + msg);
        messageEl.textContent = 'Status: ' + msg;
      }

      function setError(msg) {
        console.error('[QR DEBUG] ' + msg);
        messageEl.textContent = 'Error: ' + msg;
        messageEl.style.color = '#b00020';
      }

      function resetMessage() {
        messageEl.style.color = '';
      }

      // clear previous QR DOM and revoke any blob url used for download
      function clearQR() {
        if (lastBlobUrl) {
          URL.revokeObjectURL(lastBlobUrl);
          lastBlobUrl = null;
        }
        while (qrContainer.firstChild) qrContainer.removeChild(qrContainer.firstChild);
        downloadLink.href = '#';
        downloadLink.classList.remove('active');
        previewText.textContent = '';
      }

      // Create QR with client-side library (canvas) â€” returns true on success
      function createQRWithLibrary(text, size) {
        try {
          if (!window.QRious) {
            setError('QRious library not loaded');
            return false;
          }
          clearQR();

          // Create QR code using QRious
          const qr = new QRious({
            element: qrContainer,
            value: text,
            size: size,
            level: 'H' // high error correction level
          });

          const canvas = qrContainer.querySelector('canvas');
          if (canvas) {
            // Ensure proper size for the canvas
            canvas.width = size;
            canvas.height = size;
            const dataUrl = canvas.toDataURL('image/png');
            downloadLink.href = dataUrl;
            downloadLink.download = 'qrcode.png';
            downloadLink.classList.add('active');
            previewText.textContent = text;
            return true;
          } else {
            setError('Canvas element not found for QR code');
            return false;
          }
        } catch (err) {
          console.error(err);
          setError('QR creation failed: ' + err.message);
          return false;
        }
      }

      // Main generate function
      function generate() {
        resetMessage();
        const text = textInput.value.trim();
        if (!text) {
          alert('Please enter some text or a URL!');
          return;
        }
        const size = Number(sizeRange.value) || 256;
        log('Generating QR with size=' + size);
        createQRWithLibrary(text, size);
      }

      // Wire events
      generateBtn.addEventListener('click', generate);
      sampleBtn.addEventListener('click', () => { textInput.value = 'https://example.com'; generate(); });
      clearBtn.addEventListener('click', clearQR);
      sizeRange.addEventListener('input', () => { sizeValue.textContent = sizeRange.value; });

      // prevent download link that is not ready
      downloadLink.addEventListener('click', (e) => {
        if (downloadLink.classList.contains('disabled') || downloadLink.href === '#') {
          e.preventDefault();
          log('Download not ready');
        }
      });

      // Quick init for convenience
      textInput.value = 'https://example.com';
      generate();

    })();
  </script>
</body>
</html>
